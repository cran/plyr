test_f_problems <- function() {
  fs <- list(
    function(x) rep(x, sample(10, 1)),
    function(x) if (x < 5) x else matrix(x, 2, 2)
  )
  
  l_ply(fs, function(f) checkException(laply(1:10, f)))
}

test_simple <- function() {
  checkEqualsSansNames(laply(1:10, mean), 1:10)
  checkEqualsSansNames(laply(1:10, sqrt), sqrt(1:10))
}

test_f_matrix <- function() {
  library(abind)
  f <- function(x) matrix(x, 2, 2)
  m2d <- lapply(1:10, f)
  m3d <- abind(m2d, along = 0)
  
  checkEqualsSansNames(m3d, laply(1:10, f))

  f <- function(x) array(x, c(2, 2, 2))
  m3d <- lapply(1:10, f)
  m4d <- abind(m3d, along = 0)
  
  checkEqualsSansNames(m4d, laply(1:10, f))
}

checkEqualsSansNames <- function(x, y) {
  if (dims(x) > 1 && dims(x) == dims(y)) {
    dimnames(x) <- amv_dimnames(x)
    dimnames(y) <- amv_dimnames(x)
  }
  checkEquals(x, y)
}

test_array <- function() {  
  a <- array(1:60, c(3,4,5))
  
  checkEqualsSansNames(a, aaply(a, 1, force))
  checkEqualsSansNames(a, aaply(a, 1:2, force))
  checkEqualsSansNames(a, aaply(a, 1:3, force))
  
  checkEqualsSansNames(aperm(a, c(2,1,3)), aaply(a, 2, force))
  checkEqualsSansNames(aperm(a, c(3,1,2)), aaply(a, 3, force))

  checkEqualsSansNames(aperm(a, c(2,3,1)), aaply(a, c(2,3), force))
  checkEqualsSansNames(aperm(a, c(1,3,2)), aaply(a, c(1,3), force))
  
}